name: Deploy CDK Infrastructure

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      imageTag:
        description: 'Docker image tag to deploy (leave empty for "prod")'
        required: false
        type: string
  repository_dispatch:
    types: [backend-deployed]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install ESLint dependencies
        run: npm install --save-dev eslint typescript typescript-eslint

      - name: Lint code
        run: npx eslint . || echo "Linting completed with warnings/errors"

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

  deploy:
    runs-on: ubuntu-latest
    needs: test
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install AWS CDK
        run: npm install -g aws-cdk

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::598791268315:role/GitHubActionsCDKRole
          aws-region: us-west-1

      - name: Determine image tag
        id: image-tag
        run: |
          if [ -n "${{ github.event.client_payload.imageTag }}" ]; then
            # Triggered by backend repository dispatch
            echo "IMAGE_TAG=${{ github.event.client_payload.imageTag }}" >> $GITHUB_ENV
            echo "Using image tag from repository dispatch: ${{ github.event.client_payload.imageTag }}"
          elif [ -n "${{ inputs.imageTag }}" ]; then
            # Manual workflow dispatch with image tag
            echo "IMAGE_TAG=${{ inputs.imageTag }}" >> $GITHUB_ENV
            echo "Using image tag from manual input: ${{ inputs.imageTag }}"
          else
            # Default to 'prod' tag
            echo "IMAGE_TAG=prod" >> $GITHUB_ENV
            echo "Using default image tag: prod"
          fi

      - name: CDK diff
        run: |
          echo "Running CDK diff with image tag: $IMAGE_TAG"
          cdk diff --all --context imageTag="${IMAGE_TAG}" || echo "No changes detected by cdk diff or diff command failed."

      - name: CDK deploy
        run: |
          echo "Deploying CDK with image tag: $IMAGE_TAG"
          cdk deploy --all --require-approval never --context imageTag="${IMAGE_TAG}"
